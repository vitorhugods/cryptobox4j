name: Docker Images Release

on:
  workflow_dispatch:
  schedule:
    # At 01:00 on Saturday - build and publish images each saturday at 1:00
    - cron: '0 1 * * 6'
  release:
    types: [ published ]

env:
  CRYPTOBOX_IMAGE: wirebot/cryptobox
  RUNTIME_IMAGE: wirebot/runtime

jobs:
  tests:
    uses: ./.github/workflows/native-tests.yml
    secrets:
      webhook: ${{ secrets.WEBHOOK_RELEASE }}

  release_docker_arm64:
    uses: ./.github/workflows/docker.yml
    needs: [ tests ]
    with:
      publish: true
      cryptobox_image: ${{ env.CRYPTOBOX_IMAGE }}
      runtime_image: ${{ env.RUNTIME_IMAGE }}
      platform: linux/arm64
    secrets:
      docker_password: ${{ secrets.DOCKERHUB_PASSWORD }}
      webhook: ${{ secrets.WEBHOOK_RELEASE }}

  release_docker_amd64:
    uses: ./.github/workflows/docker.yml
    needs: [ tests ]
    with:
      publish: true
      cryptobox_image: ${{ env.CRYPTOBOX_IMAGE }}
      runtime_image: ${{ env.RUNTIME_IMAGE }}
      platform: linux/amd64
    secrets:
      docker_password: ${{ secrets.DOCKERHUB_PASSWORD }}
      webhook: ${{ secrets.WEBHOOK_RELEASE }}
